##### Redis 缓存雪崩、击穿、穿透

###### 雪崩

> redis的key全部失效

```js
如果所有首页的Key失效时间都是12小时，中午12点刷新的，我零点有个秒杀活动大量用户涌入，假设当时每秒 6000 个请求，本来缓存在可以扛住每秒 5000 个请求，但是缓存当时所有的Key都失效了。此时 1 秒 6000 个请求全部落数据库，数据库必然扛不住，它会报一下警，真实情况可能DBA都没反应过来就直接挂了。此时，如果没用什么特别的方案来处理这个故障，DBA 很着急，重启数据库，但是数据库立马又被新的流量给打死了
```

> 处理

```php
setRedis（Key，value，time + Math.random() * 10000）；
设置热点数据永远不过期，有更新操作就更新缓存就好了
（比如运维更新了首页商品，那你刷下缓存就完事了，不要设置过期时间），电商首页的数据也可以用这个操作，保险
```

击穿

```
指一个Key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个Key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个完好无损的桶上凿开了一个洞
```

> 处理

```
设置热点数据永远不过期。或者加上互斥锁就能搞定了
```

穿透

```
指缓存和数据库中都没有的数据，而用户不断发起请求，我们数据库的 id 都是1开始自增上去的，如发起为id值为 -1 的数据或 id 为特别大不存在的数据。这时的用户很可能是攻击者，攻击会导致数据库压力过大，严重会击垮数据库。
```

> 处理

```
接口层增加校验
布隆过滤器（Bloom Filter）
```

##### 上传单个视频图片只会插入最后一个数据

> 处理

```php
$data = model('Video')->field('id,img_url')->where('id' , $v['id'])->find();
    if(isset($_FILES[$v['videoImg']]['name'][0]) && !empty($_FILES[$v['videoImg']]['name'][0])){
    if(isset($v['videoImg']) && !empty($v['videoImg'])){
        // 视频封面图片上传
    }else{
    // 不存在上传新图片保持原来的数据
    if($data['id']==$v['id']){
    	$img_url = $data['img_url'];
    }
} 
```

